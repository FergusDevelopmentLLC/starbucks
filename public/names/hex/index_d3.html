<html>
<head>
    <meta charset="utf-8">
    <title>Names</title>

    <link href="http://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">
    <style>
        body {
          padding: 0;
          margin: 0;
          background: #E8E8E8;
          font-family: Montserrat,sans-serif;
        }

        h1,h2,h3 {
          font-size: 1.3em;
          font-weight: 100;
          color: #808080;
          margin: 0;
          margin-bottom: 3px;
        }

        h2 {
          font-size: 1em;
          margin-bottom: 3px;
        }

        h3 {
          font-size: .65em;
          margin-bottom: 10px;
        }

        h3 a {
          color: #808080;
        }

        #map {
          width: 900px;
          height: 600px;
          margin-left: 0px;
          margin-top: 0px;
          margin-bottom: 5px;
        }

        .slider {
          width: 200px;
        }

        #title {
          position: absolute;
          top: 10px;
          left: 20px;
          display: none;
        }

        #slider-wrapper {
          position: absolute;
          color: #808080;
          padding: 0px;
          margin: 0px;
          top: 510px;
          left: 520px;
          display: none;
        }

        #slider-wrapper div {
          text-align: center;
          font-size: .95em;
        }

        #slider-wrapper input {
          width:150px;
        }

        #legend-wrapper {
          position: absolute;
          display: none;
          top: 390px;
          left: 770px;
        }

        table {
          border-collapse: collapse;
        }

        td {
          border-color: #000;
          font-size: .65em;
        }

        tr td:first-child {
          width: 10px;
          border: 1px solid #E8E8E8;
        }

        tr td:last-child {
          padding-left: 5px;
          color: #808080;
        }

        input[type=range] {
          height: 25px;
          -webkit-appearance: none;
          margin: 0px 0;
          width: 100%;
          background-color: #E8E8E8;
        }

        input[type=range]:focus {
          outline: none;
        }
        input[type=range]::-webkit-slider-runnable-track {
          width: 100%;
          height: 5px;
          cursor: pointer;
          animate: 0.2s;
          box-shadow: 0px 0px 0px #000000;
          background: #B8B8B8;
          border-radius: 1px;
          border: 0px solid #000000;
        }
        input[type=range]::-webkit-slider-thumb {
          box-shadow: 0px 0px 0px #000000;
          border: 1px solid #B3B3B3;
          height: 18px;
          width: 18px;
          border-radius: 25px;
          background: #FFFFFF;
          cursor: pointer;
          -webkit-appearance: none;
          margin-top: -7px;
        }
        input[type=range]:focus::-webkit-slider-runnable-track {
          background: #B8B8B8;
        }
        input[type=range]::-moz-range-track {
          width: 100%;
          height: 5px;
          cursor: pointer;
          animate: 0.2s;
          box-shadow: 0px 0px 0px #000000;
          background: #B8B8B8;
          border-radius: 1px;
          border: 0px solid #000000;
        }
        input[type=range]::-moz-range-thumb {
          box-shadow: 0px 0px 0px #000000;
          border: 1px solid #B3B3B3;
          height: 18px;
          width: 18px;
          border-radius: 25px;
          background: #FFFFFF;
          cursor: pointer;
        }
        input[type=range]::-ms-track {
          width: 100%;
          height: 5px;
          cursor: pointer;
          animate: 0.2s;
          background: transparent;
          border-color: transparent;
          color: transparent;
        }
        input[type=range]::-ms-fill-lower {
          background: #B8B8B8;
          border: 0px solid #000000;
          border-radius: 2px;
          box-shadow: 0px 0px 0px #000000;
        }
        input[type=range]::-ms-fill-upper {
          background: #B8B8B8;
          border: 0px solid #000000;
          border-radius: 2px;
          box-shadow: 0px 0px 0px #000000;
        }
        input[type=range]::-ms-thumb {
          margin-top: 1px;
          box-shadow: 0px 0px 0px #000000;
          border: 1px solid #B3B3B3;
          height: 18px;
          width: 18px;
          border-radius: 25px;
          background: #FFFFFF;
          cursor: pointer;
        }
        input[type=range]:focus::-ms-fill-lower {
          background: #B8B8B8;
        }
        input[type=range]:focus::-ms-fill-upper {
          background: #B8B8B8;
        }


    </style>
</head>
<body>

<div id="title">
  <h1>Names</h1>
  <h3>Source: <a href='http://droughtmonitor.unl.edu/'>Names database</a></h3>
</div>

<div id='slider-wrapper'>
  <div>
    <div id="date"></div>
    <input type="range" class="slider">
  </div>
</div>
<div id='legend-wrapper'>
</div>

<div id="map"></div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-queue.v3.min.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script src="https://momentjs.com/downloads/moment.min.js"></script>

<script>

  var width = 900,height = 600;

  var svg = d3.select( "#map" )
    .append( "svg" )
    .attr( "width",width )
    .attr( "height",height );

  var projection = d3.geoAlbersUsa()
    .scale(1000)
    .translate([width / 2 + 35,height / 2 + 15]);

  var geoPath = d3.geoPath()
    .projection(projection);

  d3.queue()
    .defer(d3.json,'data/hex_v4.geojson')
    .defer(d3.json,'data/names_by_year.json')
    .await(makeMap);

  function makeMap(error, hex, names_by_year) {

    //var colors = ["#fee5d9","#fcae91","#fb6a4a","#de2d26","#a50f15"];

    var year = 1910;
    var colors = ["#c2a9e8","#c05f98","#6d1a50","#87cf58","#dedab7","#43bcc9","#39966d","#a95d27","#fd813b","#40a9fb","#f975ea","#8de891","#6f00f1","#032ac8","#aa8441","#44ae19","#f96277","#63f4ff","#2e4299","#d93350","#f2cc91"];
    var names_array = [];

    update(year, hex, names_by_year);

    // var filtered_by_year = names_by_year.filter(function(d) { return d.year == year; });
    //
    // var names_array = [];
    // filtered_by_year.forEach(function(d) {
    //   names_array.push(d.name);
    // });
    //
    // var total_occurrences = 0;
    // filtered_by_year.forEach(function(d) {
    //   total_occurrences += parseInt(d.total);
    // });
    //
    // var thresh = 0;
    // filtered_by_year.forEach(function(d) {
    //   d.perc = parseFloat(d.total/total_occurrences);
    //   var lastthresh = thresh;
    //   thresh += parseInt(hex.features.length * d.perc);
    //   var name = d.name;
    //   //console.log(name);
    //   //console.log(thresh);
    //   hex.features.forEach(function(d) {
    //     if(d.properties.index <= thresh && d.properties.index > lastthresh) {
    //       d.properties.name = name;
    //     }
    //   });
    // });

    //console.log(hex.features);





    var min = 1910;
    var max = 2017;

    d3.select(".slider")
      .attr("min",min)
      .attr("max",max)
      .attr("value",min)
      .attr("step", 1)
      .on("input",function() {
        console.log('here');
        update(this.value, hex, names_by_year);
      });

    // make these appear after map is painted
    d3.select("#title")
      .style("display","block");

    d3.select("#slider-wrapper")
      .style("display","block");

    function update (year, hex, names_by_year) {

      var filtered_by_year = names_by_year.filter(function(d) { return d.year == year; });

      names_array = [];
      filtered_by_year.forEach(function(d) {
        names_array.push(d.name);
      });

      var total_occurrences = 0;
      filtered_by_year.forEach(function(d) {
        total_occurrences += parseInt(d.total);
      });

      var thresh = 0;
      filtered_by_year.forEach(function(d) {
        d.perc = parseFloat(d.total/total_occurrences);
        var lastthresh = thresh;
        thresh += parseInt(hex.features.length * d.perc);
        var name = d.name;
        //console.log(name);
        //console.log(thresh);
        hex.features.forEach(function(d) {
          if(d.properties.index <= thresh && d.properties.index > lastthresh) {
            d.properties.name = name;
          }
        });
      });

      svg.append("g")
        .selectAll("path")
        .data(hex.features)
        .enter()
        .append("path")
        .attr("d",geoPath)
        .attr("fill",function(d) {
          return colors[names_array.indexOf(d.properties.name)];
        })
        .attr("stroke",function(d) {
          return colors[names_array.indexOf(d.properties.name)];
        })
        .attr("stroke-width", 1);
    }

  };

</script>
</body>
</html>
